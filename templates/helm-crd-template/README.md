# @neuron/asyncapi-helm-crd-template

Generates a working helm chart with CRDs for [Neuron operator](https://code.rbi.tech/raiffeisen/neuron-operator-application) from an AsyncAPI definition.

## Example

### AsyncAPI document
```yaml
asyncapi: '2.4.0'

info:
  title: Account Service
  version: 1.0.0
  description: This service is in charge of processing user signups

channels:
  accounts/user/signedup:
    subscribe:
      message:
        $ref: '#/components/messages/UserSignedUp'

components:
  messages:
    UserSignedUp:
      contentType: avro
      payload:
        name: User
        type: object
        properties:
          displayName:
            type: string
            description: Name of the user
          email:
            type: string
            format: email
            description: Email of the user
```

### Output
```
./output
├── Chart.yaml
├── templates
│   ├── accounts-tenant.yaml
│   ├── signedup-schema.yaml
│   ├── signedup-topic.yaml
│   └── user-namespace.yaml
└── values.yaml
```

**values.yaml** (only generated if no values.yaml exists, no overwrite)
```yaml
neuron:
  # Specifies which pulsar service to
  # talk to when deploying tenants,
  # namespaces, topics and schemas
  clusterName: dev01

  # To override special options in
  # selected tenants, namespaces and
  # topics you can set them below
  #
  # tenants:
  #   my-tenant:
  #     settings:
  #       allowedClusters:
  #         - dev01
  #       adminRoles:
  #         - admin
  #
  # namespaces:
  #   my-namespace:
  #     policies:
  #       schemaCompatibilityStrategy: FORWARD_TRANSITIVE
  #       deduplication: true
  #
  # topics:
  #   my-topic:
  #     policies:
  #       schemaCompatibilityStrategy: BACKWARD_TRANSITIVE
```

**templates/accounts-tenant.yaml**
```yaml
# This file was generated by asyncapi-generator.
# Any changes will be overwritten.

apiVersion: neuron.isf/v1alpha1
kind: NeuronTenant
metadata:
  name: accounts
spec:
  neuronClusterName: "{{ .Values.neuron.clusterName }}"
  tenant: accounts
  {{- with (( index (.Values.neuron.tenants | default dict) "accounts" ).settings) }}
  settings:
    {{- toYaml . | nindent 4 }}
  {{- end }}
```

**templates/signedup-schema.yaml**
```yaml
# This file was generated by asyncapi-generator.
# Any changes will be overwritten.

apiVersion: neuron.isf/v1alpha1
kind: NeuronSchema
metadata:
  name: signedup
spec:
  neuronClusterName: "{{ .Values.neuron.clusterName }}"
  tenant: accounts
  namespace: user
  type: AVRO
  schema:
    name: User
    type: record
    fields:
      - name: displayName
        doc: Name of the user
        default: null
        type:
          - 'null'
          - string
      - name: email
        doc: Email of the user
        default: null
        type:
          - 'null'
          - string
```

**templates/signedup-topic.yaml**
```yaml
# This file was generated by asyncapi-generator.
# Any changes will be overwritten.

apiVersion: neuron.isf/v1alpha1
kind: NeuronTopic
metadata:
  name: signedup
spec:
  neuronClusterName: "{{ .Values.neuron.clusterName }}"
  tenant: accounts
  namespace: user
  {{- with (( index (.Values.neuron.topics | default dict) "signedup" ).policies) }}
  policies:
    {{- toYaml . | nindent 4 }}
  {{- end }}
```

**templates/user-namespace.yaml**
```yaml
# This file was generated by asyncapi-generator.
# Any changes will be overwritten.

apiVersion: neuron.isf/v1alpha1
kind: NeuronNamespace
metadata:
  name: user
spec:
  neuronClusterName: "{{ .Values.neuron.clusterName }}"
  tenant: accounts
  {{- with (( index (.Values.neuron.namespaces | default dict) "user" ).policies) }}
  policies:
    {{- toYaml . | nindent 4 }}
  {{- end }}
```
